<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>RCV</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="shortcut icon" type="image/png" href="img/logo_acv2.png"/>
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css" />
	<link rel="stylesheet" href="style.css" />
  

    <link rel="stylesheet" href="src/leaflet-sidebar.css" />

</head>

<body>
    <div id="sidebar" class="sidebar collapsed">
		
		<!-- Boutons de menu -->
		<div class="sidebar-tabs" id="barre-verticale">
            <ul role="tablist" >
                <li><a href="#home" role="tab" id="logo" title="Retour à l'accueil" class="onglets"><img src="img/logo_acv2.png" style="width:30px;padding:5px"  /></a></li>
				<li><a href="img/catalogue-laureat_complet.pdf" role="tab" target="_blank" title="Télécharger le catalogue" class="onglets"><i style="vertical-align:middle;" class="fa fa-download"></i></a></li>
			</ul>
        </div>

                <!-- Contenu des onglets -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                
				<h1>&laquo; Réinventons</br>nos c&#156;urs de ville &raquo;
				<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
				
				<!-- Page d'accueil -->
				<div class="presentation" id="defaut">
					<div>
						<h2>Carte interactive des sites</h2>
						
						<div class="button_container" id="filtres">
							<div ><button class="bouton_off bouton" onclick="filtrer('0')" title="toutes les catégories" id="CHECKtout" ><i>Voir toutes les catégories</i></button></div>
							<div ><button class="bouton_off bouton" onclick="filtrer('1'); couleurBoutons('CHECK1');" title="Appel à projet en cours" id="CHECK1"><img id="picto1" src="img/picto_1_off.png" style="width:22px; padding-right:10px;" />Appel à projet en cours</button></div>
							<div ><button class="bouton_off bouton" onclick="filtrer('2'); couleurBoutons('CHECK2');" title="Ville prête à lancer son appel à projet" id="CHECK2" ><img id="picto2" src="img/picto_2_off.png" style="width:20px; padding-right:10px;" />Ville prête à lancer son appel à projet</button></div>
							<div ><button class="bouton_off bouton" onclick="filtrer('3'); couleurBoutons('CHECK3');" title="Ville sélectionnée dans le cadre de Réinventons nos cœurs de ville" id="CHECK3" ><img id="picto3" src="img/picto_3_off.png" style="width:17px; padding-right:10px;" />Ville sélectionnée dans le cadre de &laquo;Réinventons nos cœurs de ville&raquo;</button></div>
						</div>
							
					</div>
					
					<div id="sources" style="width:70%;">
						<p><i>Sources&nbsp;: <a href="https://www.cget.gouv.fr/dossiers/action-coeur-de-ville" target="_blank">CGET</a> • Réalisation&nbsp;: <a href="https://cartotheque.cget.gouv.fr/cartes?filters%5Bquery%5D=interactif&current_page=1&category=&page_size=20" target="_blank">CGET service cartographie</a></i></p>
						<p><img src="img/cget.png" style="vertical-align:middle; width:100%;"/></p>
					</div>
				</div>
				
				<!-- Contenu de la fiche d'information -->
				<div class="divTable" id="popup">
					<div id="libgeo"></div>
					<div style="text-transform:uppercase; font-size:2em; color:#fab612; font-weight:bold;" id="ville"></div>
					<div style="font-size:1.5em; color:#fab612;" id="nom"></div>
					<div style="margin-top:10px" id="dep"></div>
					<div style="margin-top:10px;font-size:0.9em;" id="type"></div>
					<div style="margin-top:15px;margin-bottom:15px;" id="lienBOX"><img src="img/picto_fleche.png" style="vertical-align:middle; width:20px;" /><span id="lien"></span></div>
					<div style="margin-top:15px;margin-bottom:15px;" id="taquet"><img src="img/picto_taquet.png" style="vertical-align:middle; width:40px;" /></div>
					<div class="divTableBody">
					
						<div class="divTableCell" id="orientationBOX">
								<div class="divTableRow"><span style="text-transform:uppercase; font-size:1em; color:#ffffff; background-color:#d11558; padding:2px; ">Les Orientations programmatiques&nbsp;:</span></div>
								<div class="" id="orientation" style="border:1px solid #d11558; padding:2px; "></div>
						</div>
						<div class="divTableCell" id="contactBOX">
								<h3 class="divTableRow">Contact&nbsp;:</h3>
								<div class="divTableRow" id="contact"></div>
						</div>
						<div class="divTableCell" id="foncierBOX">
								<h3 class="divTableRow">Maîtrise foncière&nbsp;:</h3>
								<div class="divTableRow" id="foncier"></div>
						</div>
						<div class="divTableCell" id="surfaceBOX">
								<h3 class="divTableRow">Superficie (en m²)&nbsp;:</h3>
								<div class="divTableRow" id="superficie"></div>
						</div>
					</div>
					<div id="retour" style='margin-top:25px;'><img src='img/picto_fleche.png' style="vertical-align:middle; width:20px; margin-right:5px;"  />Retour</div>
				</div>
					
            </div>

        </div>
    </div>


	<div id="mapid"></div>
	
    <script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js"></script>
    <script src="src/leaflet-sidebar.js"></script>
	<!--<script type="text/javascript" src='src/tabletop.min.js'></script>-->
	<script type="text/javascript" src="data/masque.js"></script>
	<script type="text/javascript" src="data/cercles_drom.js"></script>
	<script type="text/javascript" src="data/toutesCouches.js"></script>
	<script type="text/javascript" src="data/rcv.js"></script>
	
    <script>
		
		
		
		// Création de la carte
		var map = L.map('mapid', {maxZoom:8, minZoom:6, maxBounds: [[39, -28],[54, 30]]})
		.setView([46.5, -1.8], 6);
		map.zoomControl.setPosition('topright');
		map.attributionControl.addAttribution('<a href="https://cartotheque.cget.gouv.fr/cartes" style="text-decoration:none;" target="_blank ">CGET</a>');
		
		//Ajout de la sidebar
		var sidebar = L.control.sidebar('sidebar').addTo(map);
		sidebar.open('home');
		
/* COULEURS - STYLES - LEGENDE */
		
		//Définition des pictos
		var LeafIcon = L.Icon.extend({
		options: {
		}
		});
		var picto1_off = new LeafIcon({iconUrl: 'img/picto_1_off.png', iconSize: [22,22], iconAnchor:[11,11]}),
			picto2_off = new LeafIcon({iconUrl: 'img/picto_2_off.png', iconSize: [20,20], iconAnchor:[10,10]}),
			picto3_off = new LeafIcon({iconUrl: 'img/picto_3_off.png', iconSize: [12,12], iconAnchor:[6,6]}),
			picto1_on = new LeafIcon({iconUrl: 'img/picto_1_on.png', iconSize: [33,33], iconAnchor:[16.5,16.5]}),
			picto2_on = new LeafIcon({iconUrl: 'img/picto_2_on.png', iconSize: [33,33], iconAnchor:[16.5,16.5]}),
			picto3_on = new LeafIcon({iconUrl: 'img/picto_3_on.png', iconSize: [33,33], iconAnchor:[16.5,16.5]});
		
		var picto_cible = new LeafIcon({iconUrl: 'img/picto_cible.png', iconSize: [36,36], iconAnchor:[18,18]});

		function createIcon(type, statut) {
			if (statut=="off"){
				if (type=='1') {return picto1_off;}
				else if (type=='2') {return picto2_off;}
				else {return picto3_off;}
				}
			else {
				if (type=='1') {return picto1_on;}
				else if (type=='2') {return picto2_on;}
				else {return picto3_on;}
			}
		}
		
/* CREATION DES COUCHES */		
		
		//Niveaux d'affichage des couches
		map.createPane('fond');
		map.getPane('fond').style.zIndex = 500;
		map.createPane('contour');
		map.getPane('contour').style.zIndex = 500;
		map.createPane('cercles');
		map.getPane('cercles').style.zIndex = 510;
		map.createPane('metro');
		map.getPane('metro').style.zIndex = 520;
		map.createPane('metCible2');
		map.getPane('metCible2').style.zIndex = 525;
		map.createPane('metCible');
		map.getPane('metCible').style.zIndex = 530;
		
		//Couches du fond de carte
		Cache = L.geoJSON(JS_masque, {color: "#fab612", weight: 0, opacity: 1, fillOpacity: 1}).addTo(map);
		Cercles_drom = L.geoJSON(JS_drom, {color: "#ffffff", weight: 2, opacity: 0.7, fillOpacity: 0}).addTo(map);
		
		Fond_Regions = L.geoJSON(JS_tout, {
			filter: function(feature, layer) {return feature.properties.type=="région"},
			style : {weight: 0, opacity: 1, fillOpacity: 1, fillColor:"#e51b48", pane: "fond"}
			}).addTo(map);
		
		Contour_Regions = L.geoJSON(JS_tout, {
			filter: function(feature, layer) {return feature.properties.type=="région"},
			style : {color: "#ffffff", weight: 2, opacity: 1, fillOpacity: 0, pane: "contour"}
			}).addTo(map);
		
		Departements = L.geoJSON(JS_tout, {
			filter: function(feature, layer) {return feature.properties.type=="départemen"},
			style: {color: "#ffffff", weight: 1, opacity: 1, fillOpacity: 0, pane: "contour"}
			}).addTo(map);
		
		ZAU = L.geoJSON(JS_tout, {
			filter: function(feature, layer) {return feature.properties.type=="zau"},
			style: function(feature){
				if (feature.properties.codgeo=="120"){
					return {opacity: 1, fillOpacity: 1, weight: 0, color:"#d61943", pane: "fond"};
				}
				else if (feature.properties.codgeo=="112"){
					return {opacity: 1, fillOpacity: 1, weight: 0, color:"#c7183e", pane: "fond"};
				}
				else if (feature.properties.codgeo=="111"){
					return {opacity: 1, fillOpacity: 1, weight: 0, color:"#b81638", pane: "fond"};
				}
				else {
					return {opacity: 1, fillOpacity: 1, weight: 0, color:"#e51b48", pane: "fond"};
				}
			}
		})
		.addTo(map);
		
/* PROJETS */
		
		
		
		// Ajout des couches de point
	
		var projets1 = L.layerGroup({pane:'metro'}).addTo(map);
		var projets2 = L.layerGroup({pane:'metro'}).addTo(map);
		var projets3 = L.layerGroup({pane:'metro'}).addTo(map);
	
		function creationProjets(categorie) {
			
			Projets_dotation = L.geoJSON(JS_rcv, {
				filter : function(feature){
					if (categorie =='1') {return feature.properties.id_type == "1"}
					else if (categorie =='2') {return feature.properties.id_type == "2"}
					else if (categorie =='3') {return feature.properties.id_type == "3"}
					else {return feature.properties.id_type == "3" || feature.properties.id_type == "2" || feature.properties.id_type == "1"}
				},
				pointToLayer: function(feature, latlng) {
					var marker = L.marker(latlng,{icon: createIcon(feature.properties.id_type,'off')});
					marker.bindTooltip(feature.properties.lib_com, {className: 'Tooltips', closeButton: false, direction:'left', offset: [-10,0]});
					marker.on('click', function(e){popup(e.target);markerCible(e.target) });
					marker.on('mouseover', function(e){e.target.setIcon(createIcon(feature.properties.id_type, 'on' )); });
					marker.on('mouseout', function(e){e.target.setIcon(createIcon(feature.properties.id_type, 'off')); });
					
					marker.properties = {};
					marker.properties.insee_com = feature.properties.insee_com;
					marker.properties.lib_com = feature.properties.lib_com;
					marker.properties.lib_projet = feature.properties.lib_projet;
					marker.properties.insee_dep = feature.properties.insee_dep;
					marker.properties.lib_dep = feature.properties.lib_dep;
					marker.properties.insee_reg = feature.properties.insee_reg;
					marker.properties.lib_rcv = feature.properties.lib_rcv;
					marker.properties.orientations = feature.properties.orientations;
					marker.properties.contact_p = feature.properties.contact_p;
					marker.properties.contact_n = feature.properties.contact_n;
					marker.properties.contact_m = feature.properties.contact_m;
					marker.properties.contact_t = feature.properties.contact_t;
					marker.properties.url1 = feature.properties.url1;
					marker.properties.url2 = feature.properties.url2;
					marker.properties.foncier = feature.properties.foncier;
					marker.properties.surface = feature.properties.surface;
					marker.properties.type = feature.properties.type;
					marker.properties.id_type = feature.properties.id_type;
					
					if (feature.properties.id_type == '1') {projets1.addLayer(marker);}
					else if (feature.properties.id_type == '2') {projets2.addLayer(marker);}
					else {projets3.addLayer(marker);}
					
				}
				});
		
		}
		
		creationProjets('0');

		function filtrer(categorie) {
			if (categorie == '1'){
				map.addLayer(projets1);
				map.removeLayer(projets2);
				map.removeLayer(projets3);
			}
			else if (categorie == '2'){
				map.removeLayer(projets1);
				map.addLayer(projets2);
				map.removeLayer(projets3);
			}
			else if (categorie == '3'){
				map.removeLayer(projets1);
				map.removeLayer(projets2);
				map.addLayer(projets3);
			}
			else {
				map.addLayer(projets1);
				map.addLayer(projets2);
				map.addLayer(projets3);
				document.getElementById('CHECK1').setAttribute("class", "bouton bouton_off");
				document.getElementById('CHECK2').setAttribute("class", "bouton bouton_off");
				document.getElementById('CHECK3').setAttribute("class", "bouton bouton_off");
			}
		}
		
		function couleurBoutons(e) { 
			document.getElementById('CHECK1').setAttribute("class", "bouton bouton_off");
			document.getElementById('CHECK2').setAttribute("class", "bouton bouton_off");
			document.getElementById('CHECK3').setAttribute("class", "bouton bouton_off");
			document.getElementById(e).setAttribute("class", "bouton bouton_on");
		}
		
		
		
/* DONNEES DRIVE 
			
		//Ajout des données drive
		var publicSpreadsheetUrl = 'https://docs.google.com/spreadsheets/d/17Fj-vJg50BOjz5WLqhSy-BPdouadxqnCTM81OUiRJ6E/edit?usp=sharin';
		
		function init() {
			Tabletop.init({ 
				key: publicSpreadsheetUrl,
				callback: showInfo,
				simpleSheet: true
			})
		}
	
		//Création du layer de markers
		var markersLayer = new L.layerGroup();
		markersLayer.addTo(map);
	
		//Aller chercher les données et créer les markers
		function showInfo(data, tabletop) {
			
			for (var i in data){

				marker = new L.marker([data[i].LAT, data[i].LNG], {title: data[i].lib_com});
				
				if (data[i].ID_ASSO == 'AMF'){marker.setIcon(picto1_off); marker.on('mouseover', function(e) {e.target.setIcon(picto1_on); }); marker.on('mouseout', function(e) {e.target.setIcon(picto1_off); });}
				else if (data[i].ID_ASSO == 'ATMF'){marker.setIcon(picto2_off); marker.on('mouseover', function(e) {e.target.setIcon(picto2_on); }); marker.on('mouseout', function(e) {e.target.setIcon(picto2_off); });}
				else {marker.setIcon(picto3_off); marker.on('mouseover', function(e) {e.target.setIcon(picto3_on); }); marker.on('mouseout', function(e) {e.target.setIcon(picto3_off); });}
				
				marker.properties = {};
				marker.properties.ID_ASSO = data[i].ID_ASSO;

				marker.bindTooltip(data[i].ID_ASSO, {className: 'Tooltips', closeButton: false, offset: [0,-30]});
				marker.on('click', function(e) {popup(e.target); markerCible(e.target) });
				
				marker.addTo(markersLayer);
				
			}
		}

		window.addEventListener('DOMContentLoaded', init)*/
		
		
		
		
		//Action au clic sur un marker
		function popup(e) {
			//ouverture de la sidebar
			if (document.getElementById('sidebar').classList.contains('collapsed')){
				sidebar.open('home');
				}
			
			//Remplissage de la popup
			document.getElementById('popup').style.display = "block";
			document.getElementById('defaut').style.display = "none";
			
			document.getElementById('ville').innerHTML = e.properties.lib_com;
			
			if (e.properties.url1 != 'non'){
				document.getElementById('lienBOX').style.display = "block";
				document.getElementById('lien').innerHTML = "<span><a href='"+e.properties.url1+"' target='blank'>Télécharger le dossier</a></span>";
				}
			else document.getElementById('lienBOX').style.display = "none";
			
			document.getElementById('nom').innerHTML = e.properties.lib_projet;
			document.getElementById('type').innerHTML = "<span><i>"+e.properties.type+"</i></span>";
			document.getElementById('dep').innerHTML = "<span>"+e.properties.lib_dep+" - "+e.properties.insee_dep+"</span>";
			
			if (e.properties.orientations != 'non'){
				document.getElementById('orientationBOX').style.display = "block";
				document.getElementById('orientation').innerHTML = "<span>"+e.properties.orientations+"</span>";
				}
			else document.getElementById('orientationBOX').style.display = "none";
			
			if (e.properties.contact_n != 'non'){
				document.getElementById('contactBOX').style.display = "block";
				document.getElementById('contact').innerHTML = "<span>"+e.properties.contact_p+" "+e.properties.contact_n+"</br>"+e.properties.contact_m+"</br>"+e.properties.contact_t+"</span>";
				}
			else document.getElementById('contactBOX').style.display = "none";
			
			if (e.properties.foncier != 'non'){
				document.getElementById('foncierBOX').style.display = "block";
				document.getElementById('foncier').innerHTML = "<span>"+e.properties.foncier+"</span>";
				}
			else document.getElementById('foncierBOX').style.display = "none";
			
			if (e.properties.surface != 'non'){
				document.getElementById('surfaceBOX').style.display = "block";
				document.getElementById('superficie').innerHTML = "<span>"+e.properties.surface+"</span>";
				}
			else document.getElementById('surfaceBOX').style.display = "none";
			
		}
		
		//Une cible sur le marker sélectionné
		var markerCib;
		function markerCible(e) {
			if(markerCib) {map.removeLayer(markerCib);}
			markerCib = new L.marker(new L.latLng(e._latlng), {icon: picto_cible, pane:"cercles"});
			markerCib.setZIndexOffset(-50);
			markerCib.addTo(map);
		}
		
		//Action au clic sur "retour"
		document.getElementById("retour").addEventListener("click", function(event){
			event.stopPropagation();
			document.getElementById('popup').style.display = "none";
			document.getElementById('defaut').style.display = "block";
			if(markerCib) {map.removeLayer(markerCib);}
		});

		//Events au clic sur la carte
		map.on('click', function(e) {   
			sidebar.open('home');
			document.getElementById('popup').style.display = "none";
			document.getElementById('defaut').style.display = "block";
			if(markerCib) {map.removeLayer(markerCib);}
			map.setView([46.5, -1.8], 6);
			map.addLayer(projets1);
			map.addLayer(projets2);
			map.addLayer(projets3);
			document.getElementById('CHECK1').setAttribute("class", "bouton bouton_off");
			document.getElementById('CHECK2').setAttribute("class", "bouton bouton_off");
			document.getElementById('CHECK3').setAttribute("class", "bouton bouton_off");			
		});
		

   </script>
	
</body>



</html>
